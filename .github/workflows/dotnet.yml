name: .NET

on:
    push:
        branches: [main]
        tags:
            - "v*"
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x

            - name: Restore dependencies
              run: dotnet restore

            - name: Build
              run: dotnet build --no-restore --configuration Release

            - name: Test
              run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage"

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  files: ./tests/**/coverage.cobertura.xml
                  fail_ci_if_error: false

            - name: Pack NuGet package
              run: dotnet pack src/NativeLambdaRouter/NativeLambdaRouter.csproj --no-build --configuration Release --output ./nupkg

            - name: Upload NuGet package artifact
              uses: actions/upload-artifact@v4
              with:
                  name: nuget-package
                  path: ./nupkg/*.nupkg

    publish:
        name: Publish to NuGet
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Download NuGet package artifact
              uses: actions/download-artifact@v4
              with:
                  name: nuget-package
                  path: ./nupkg

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x

            - name: Publish to NuGet.org
              run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
